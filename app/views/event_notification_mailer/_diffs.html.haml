- if @suppress_diff
  .alert.alert-block
    %p
      %strong Warning! Large commit with more than #{Commit::DIFF_SAFE_SIZE} files changed or contain more than #{Commit::DIFF_SAFE_LINES_COUNT} lines of code.
    %p To prevent performance issue we rejected diff information.

%p{style: "color:gray"}
  Showing #{pluralize(diffs.count, "changed file")}

%table
  - diffs.each_with_index do |diff, i|
    %tr
      - if diff.deleted_file
        %td
          %a{href: "#diff-#{i}"}
            -
            = diff.old_path
      - elsif diff.renamed_file
        %td
          %a{href: "#diff-#{i}"}
            -
            = diff.old_path
            = "->"
            = diff.new_path
      - elsif diff.new_file
        %td
          %a{href: "#diff-#{i}"}
            +
            = diff.new_path
      - else
        %td
          %a{href: "#diff-#{i}"}
            *
            = diff.new_path

- unless @suppress_diff
  - diffs.each_with_index do |diff, i|
    - next if diff.diff.empty?
    - file = Gitlab::Git::Blob.new(@repository, @commit.id, @ref, diff.new_path)
    - file = Gitlab::Git::Blob.new(@repository, @commit.parent_id, @ref, diff.old_path) unless file.exists?
    - next unless file.exists?
    %br
    %table{id: "diff-#{i}", cellspacing: '0', cellpadding: '0', style: "border:1px solid #ccc; color: #444; width:100%"}
      %tr
        %td{colspan: 3, style: "padding:5px 5px 5px 10px;color:#555;border-bottom:1px solid #ccc;background:#eee;"}
          - if diff.deleted_file
            %span{style: "font-size:0.8em"}
              = diff.old_path
              - if @commit.parent_ids.present?
                = link_to project_blob_url(@project, tree_join(@commit.parent_id, diff.new_path)), {:class => 'btn btn-tiny pull-right view-file'} do
                  View file @
                  %span{style: "font-family:\"Menlo\",\"Liberation Mono\",\"Consolas\",\"Courier New\",\"andale mono\",\"lucida console\",monospace;font-size:smaller"}
                    = @commit.short_id(6)
          - else
            %span= diff.new_path
            - if diff.a_mode && diff.b_mode && diff.a_mode != diff.b_mode
              %span.file-mode= "#{diff.a_mode} â†’ #{diff.b_mode}"

            = link_to project_blob_url(@project, tree_join(@commit.id, diff.new_path)), {:class => 'btn btn-tiny pull-right view-file'} do
              View file @
              %span{style: "font-family:monospace;"}
                = @commit.short_id(6)

      %tr
        %td{colspan: 3, style: "overflow:auto;overflow-y:hidden; color:#333; background:#fff; max-width:1024px;"}
          -# Skipp all non non-supported blobs
          - next unless file.respond_to?('text?')
          - if file.text?
            = render "event_notification_mailer/text_file", diff: diff, index: i
          - else
            %p
              No preview for this file type
