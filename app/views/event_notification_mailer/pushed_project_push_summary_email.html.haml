!!! 5
%html{ lang: "en"}
  %head
    %meta{charset: "utf-8"}
    %title
      = "#{title} | " if defined?(title)
      GitLab
    = stylesheet_link_tag    "application"
  %body
    %p.cgray
      = "Showing #{pluralize(@diffs.count, "changed file")}"
    .file-stats
      %ul.bordered-list
        - @diffs.each_with_index do |diff, i|
          %li
            - if diff.deleted_file
              %span.deleted-file
                %a{href: "#diff-#{i}"}
                  %i.icon-minus
                  = diff.old_path
            - elsif diff.renamed_file
              %span.renamed-file
                %a{href: "#diff-#{i}"}
                  %i.icon-minus
                  = diff.old_path
                  = "->"
                  = diff.new_path
            - elsif diff.new_file
              %span.new-file
                %a{href: "#diff-#{i}"}
                  %i.icon-plus
                  = diff.new_path
            - else
              %span.edit-file
                %a{href: "#diff-#{i}"}
                  %i.icon-adjust
                  = diff.new_path

    .files
      - @diffs.each_with_index do |diff, i|
        - next if diff.diff.empty?
        - file = (@commit.tree / diff.new_path)
        - file = (@commit.prev_commit.tree / diff.old_path) unless file
        - next unless file
        .file{id: "diff-#{i}"}
          .header
            - if diff.deleted_file
              %span= diff.old_path

              - if @commit.prev_commit
                = link_to project_tree_path(@project, tree_join(@commit.prev_commit_id, diff.new_path)), {class: 'btn pull-right view-file'} do
                  View file @
                  %span.commit-short-id= @commit.short_id(6)
            - else
              %span= diff.new_path
              - if diff.a_mode && diff.b_mode && diff.a_mode != diff.b_mode
                %span.file-mode= "#{diff.a_mode} â†’ #{diff.b_mode}"

              = link_to project_tree_path(@project, tree_join(@commit.id, diff.new_path)), {class: 'btn btn-tiny pull-right view-file'} do
                View file @
                %span.commit-short-id= @commit.short_id(6)

          .content
            -# Skipp all non non-supported blobs
            - next unless file.respond_to?('text?')
            - if file.text?
              - too_big = diff.diff.lines.count > 1000
              - if too_big
                %a.supp_diff_link Diff suppressed. Click to show

              %table.text-file{class: "#{'hide' if too_big}"}
                - each_diff_line(diff, i) do |line, type, line_code, line_new, line_old|
                  %tr.line_holder{ id: line_code }
                    - if type == "match"
                      %td.old_line= "..."
                      %td.new_line= "..."
                      %td.line_content.matched= line
                    - else
                      %td.old_line
                        = link_to raw(type == "new" ? "&nbsp;" : line_old), "##{line_code}", id: line_code
                      %td.new_line= link_to raw(type == "old" ? "&nbsp;" : line_new) , "##{line_code}", id: line_code
                      %td.line_content{class: "noteable_line #{type} #{line_code}", "line_code" => line_code}= raw diff_line_content(line)
    = render "footer", user: @user
