- if @suppress_diff
  .alert.alert-block
    %p
      %strong Warning! Large commit with more than #{Commit::DIFF_SAFE_FILES} files changed or contain more than #{Commit::DIFF_SAFE_LINES} lines of code.
    %p To prevent performance issue we rejected diff information.

%p Showing #{pluralize(diffs.size, "changed file")}

%table{style: "width: 100%;"}
  - diffs.each_delta.each_with_index do |delta, i|
    %tr
      - if delta.deleted?
        %td
          %a{href: "#diff-#{@commit.oid}-#{i}"}
            -
            = delta.old_file[:path]
      - elsif delta.renamed?
        %td
          %a{href: "#diff-#{@commit.oid}-#{i}"}
            -
            = delta.old_file[:path]
            = "->"
            = delta.new_file[:path]
      - elsif delta.added?
        %td
          %a{href: "#diff-#{@commit.oid}-#{i}"}
            +
            = delta.new_file[:path]
      - else
        %td
          %a{href: "#diff-#{@commit.oid}-#{i}"}
            *
            = delta.new_file[:path]

- unless @suppress_diff
  - diffs.each_patch.each_with_index do |diff, i|
    - file = nil
    -#- next if diff.diff.empty?
    - file = @repository.blob_at(@commit.oid, diff.delta.new_file[:path])
    - file = @repository.blob_at(@commit.parent_ids.first, diff.delta.old_file[:path]) unless file
    - next unless file
    %br
    %table{id: "diff-#{@commit.oid}-#{i}", style: "border:1px solid #ccc; color: #444; width:100%; font-size:0.8em"}
      %tr
        %td{colspan: 3}
          - if diff.delta.deleted?
            %span
              = diff.delta.old_file[:path]
              - if @commit.parent_ids.present?
                = link_to project_blob_url(@project, tree_join(@commit.parent_ids.first, diff.delta.new_file[:path])) do
                  View file @
                  %span{style: "font-size:smaller"}
                    = @commit.oid[0..6]
          - else
            %span= diff.delta.new_file[:path]
            - if diff.delta.old_file[:mode] && diff.delta.new_file[:mode] && diff.delta.old_file[:mode] != diff.delta.new_file[:mode]
              %span.file-mode= "#{'%06o' % diff.delta.old_file[:mode]} â†’ #{'%06o' % diff.delta.new_file[:mode]}"

            = link_to project_blob_url(@project, tree_join(@commit.oid, diff.delta.new_file[:path])) do
              View file @
              %span{style: "font-family:monospace;"}
                = @commit.oid[0..6]

      %tr
        %td{colspan: 3, style: "overflow:auto;overflow-y:hidden; color:#333; background:#fff; width:100%;"}
          -# Skipp all non non-supported blobs
          - next unless file.respond_to?('text?')
          - if file.text?
            = render "event_summary_mailer/project/push/text_file", diff: diff, index: i
          - else
            No preview for this file type
